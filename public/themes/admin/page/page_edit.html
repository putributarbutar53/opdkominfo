<!DOCTYPE html>
<html lang="en-US" dir="ltr">

  <head>
    <link href="assets/lib/flatpickr/flatpickr.min.css" rel="stylesheet">
    <script src="assets/js/config.navbar-vertical.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="assets/lib/perfect-scrollbar/perfect-scrollbar.css" rel="stylesheet">
    <link href="assets/lib/prismjs/prism-okaidia.css" rel="stylesheet">
    <link href="assets/lib/datatables-bs4/dataTables.bootstrap4.min.css" rel="stylesheet">
    <link href="assets/lib/datatables.net-responsive-bs4/responsive.bootstrap4.css" rel="stylesheet">
    <link href="assets/lib/dropzone/dropzone.min.css" rel="stylesheet">
    <link href="assets/css/theme.css" rel="stylesheet">
  </head>

  <body>

{if $Detail.id != ''}
<div class="modal-header">
  <h5 class="modal-title" id="add"><span class="text-primary">{$Detail.vPageName|no_value}
    {if $detailConf.iLiveEditor == '1'}&nbsp;<a href="{$base_url}{$index_page}pages/{$Detail.vPermalink}.html" target="_blank"><i class="fas fa-external-link-alt"></i></a>{/if}
  </span></h5>
  <h6 style="float:right;">
    {if $detailConf.iAddPage == '1'}<a href="javascript:addsubpage({$Detail.id});" class="btn btn-success btn-sm"><i class="fas fa-wrench"></i>&nbsp;Add Sub</a>{/if}
    <a href="javascript:editconf({$Detail.id});" class="btn btn-info btn-sm"><i class="fas fa-wrench"></i>&nbsp;Page Conf</a>
    {if $detailConf.iLiveEditor == '1'}
    {* <a href="{$base_url}builder/design.php?id=6037a0a8583a7&type=default" target="_blank" class="btn btn-warning btn-sm"><i class="fas fa-highlighter"></i>&nbsp;Live Editor</a> *}
    <a href="{$base_url}builder/design.php?id={$Detail.id}&type=page" target="_blank" class="btn btn-warning btn-sm"><i class="fas fa-highlighter"></i>&nbsp;Live Editor</a>
    {/if}
  </h6>
</div>
<div class="modal-body text-left">

        <form id="add_submit" method="post" enctype="multipart/form-data">
        <input type="hidden" name="action" value="update" />
        <input type="hidden" name="idPage" value="{$Detail.id}" />
        <input type="hidden" name="nAdmin" value="{$DetailAdmin.vName}" />

          Page Name:<br />
          <input type="text" name="vPageName" value="{$Detail.vPageName}" class="form form-control form-50" size="40" />
          {if $detailConf.iOpsi == '1'}<input type="text" name="vPermalink" value="{$Detail.vPermalink}" placeholder="Permalink" class="form form-control form-50" size="40" />{/if}
          <br />

          {if $detailConf.iContent == '1'}
          Content:<br />
            {if $detailConf.iEditor == '1'}
            <input type="hidden" id="no_editor" name="no_editor" value="no" />
            <div class="min-vh-50">
            <textarea class="form form-control tinymce" id="tContent" name="tContent">{$Detail.tContent}</textarea>
            </div>
            {else}
            <input type="hidden" id="no_editor" name="no_editor" value="yes" />
            <textarea class="form form-control tinymce" cols="80" rows="20" id="tContent" name="tContent">{$Detail.tContent}</textarea><br />
            {/if}
            <input type="hidden" name="tContent_status" value="1" />
          {else}
            <input type="hidden" id="no_editor" name="no_editor" value="yes" />
          {/if}
          {if $detailConf.iAttch == '1'}
          Lampiran: <br />
{section name=i loop=$listFile step=1}
    {$listFile[i].name}<button class="btn btn-sm" type="button" onclick="hapusfile('{$listFile[i].id}','{$smarty.section.i.index}')"><span class="fas fa-trash-alt text-danger mt-n4"></span></button><br>
    
{/section}

<div class="row">
          <div class="col">
            <ul id="ListEdit"></ul>
          </div>
        </div>
<div class="custom-file">
          <input
            class="d-none"
            id="file_edit"
            name="files[]"
            multiple
            type="file"
          />
          <label class="btn btn-primary btn-sm" for="file_edit"
            ><span class="fas fa-camera fs-1"></span> Upload file</label
          >
        </div><br>
        {/if}
        {if $detailConf.iLink == '1'}
        {section name=i loop=$listLinkFile step=1}
  <a href="{$listLinkFile[i]}" target="_blank">{$listLinkFile[i]}</a><button class="btn btn-sm" type="button" onclick="hapuslink('{$listLinkFile[i]}')"><span class="fas fa-trash-alt text-danger mt-n4"></span></button><br>
{/section}
            Link File : 
            <button
              class="btn btn-info btn-sm my-3"
              type="button"
              id="btn_add_form_link"
              onclick="addform()"
            >
              <i class="fas fa-plus-square"></i> Link File
            </button>
            <br>
            {/if}
            
          Tanggal Publikasi:<br />
          <div class="form-group">
          <input
            class="form-control editdatetimepicker"
            name="dCreated"
            value="{$Detail.dCreated}"
            id="datetimepicker"
            type="text"
            placeholder="yyyy-mm-dd : H:i"
            data-options='{literal}{"dateFormat":"d/m/y H:i"}{/literal}'
          />
        </div>

          <!-- Gambar:<br />
          <input type="file" name="vGambar"> -->
          {if $detailConf.iPictureIcon == '1'}
          Gambar:<br />
          {literal}
          <div id="drop_image" class="dropzone dropzone-single p-0" data-dropzone data-options='{"url":"valid/url","maxFiles":1,"dictDefaultMessage":"Choose or Drop a file here"}'>
          {/literal}
            <div class="fallback">
              <input type="file" name="lbPicture">
            </div>
            <div class="dz-preview dz-preview-single">
              <div class="dz-preview-cover dz-complete"><img class="dz-preview-img" src="..." alt="..." data-dz-thumbnail=""><a class="dz-remove text-danger" href="#!" data-dz-remove><span class="fas fa-times"></span></a>
                <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress=""></span></div>
              </div>
            </div>
            <div class="dz-message" data-dz-message>
              <div class="dz-message-text"><img class="mr-2" src="assets/img/icons/cloud-upload.svg" width="25" alt="">Drop your file here</div>
            </div>
          </div>    
          {if $Detail.lbPicture != ''}
          <p><a href="{$base_url}{$pageDir}{$Detail.lbPicture}" data-fancybox="gallery" data-caption="{$Detail.vPageName}"><img src="{$base_url}{$pageDir}{$Detail.lbPicture}" class="img-fluid" width="350" /></a>
            <a href="javascript:deletephoto({$Detail.id});"><i class='fas fa-trash-alt h6'></i></a></p>
          {/if}            
          <input type="hidden" name="no_picture" id="no_picture" value="no" />
          <br />
          {else}
          <input type="hidden" name="no_picture" id="no_picture" value="yes" />
          {/if}

          {if $detailConf.iMenuURL == '1'}
          Link URL:<br />
          <input type="text" name="vURL" value="{$Detail.vURL}" class="form form-control form-50" size="40" />
          <br />
          {/if}

          {if $detailConf.iLinkTarget == '1'}
          Link Target:<br />
          <select name="cURLTarget" class="form form-control form-30">
            <option{if $Detail.cURLTarget == '_self'} selected{/if} value="_self">Self</option>
            <option{if $Detail.cURLTarget == '_blank'} selected{/if} value="_blank">Blank</option>
          </select>
          <br />
          {/if}

          {if $detailConf.iMeta == '1'}
          Meta Title:<br />
          <input type="text" name="vMetaTitle" value="{$Detail.vMetaTitle}" class="form form-control form-50" size="40" />
          <br />

          Meta Description:<br />
          <textarea cols="80" rows="2" class="form form-control form-50" name="vMetaDesc">{$Detail.vMetaDesc}</textarea>
          <br />

          Meta Keyword:<br />
          <textarea cols="80" rows="2" class="form form-control form-50" name="vMetaKeyword">{$Detail.vMetaKeyword}</textarea>
          <br />
          {/if}
          
          {if $detailConf.iOpsi == '1'}
          Status:<br />
          <select name="iShow" class="form form-control form-30">
            <option{if $Detail.iShow == '1'} selected{/if} value="1">Published</option>
            <option{if $Detail.iShow == '0'} selected{/if} value="0">Draft</option>
          </select>
          <br />

          Urutan:<br />
          <input type="text" name="iUrutan" value="{$Detail.iUrutan}" class="form form-control form-50" size="40" />
          <br />
          {/if}

          <span id="report"></span>

          <input type="submit" name="submit" value="Perbaharui Page" class="btn btn-primary" />
        </form>

        <br />

        {if $detailConf.iModule == '1'}

        <span id="report_module"></span>

        <div class="card mb-3">
          <div class="card-body bg-light border-top">
            <div class="row">
              <div class="col-lg col-xxl-5">
    
      <h6 class="font-weight-semi-bold ls mb-3 text-uppercase">Data Module&nbsp;&nbsp;
        <button class="btn btn-warning btn-sm" type="button" onclick="javascript:addmodule();"><i class="fas fa-plus-square"></i>&nbsp;Modul</button>
      </h6>
      <table id="table_modul" width="100%" class="table mb-0 table-striped table-dashboard data-table border-bottom border-200">
        <thead class="bg-200">
        <tr>
          <th><b>Name</b></th>
          <th><b>Data</b></th>
          <th><b>Gambar</b></th>
          <th><b>#</b></th>
        </tr>
        </thead>
      </table>
    
      </div></div></div></div>
    
      {/if}

      </div>

<div class="modal fade" id="addsub" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="sub_add">
    </div>
  </div>
</div>

{include file='page/page_module_add.html'}

<div class="modal fade" id="module_edit" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="module_editor"></div>
  </div>
</div>
    
{else}
<div class="modal-header">
  <h5 class="modal-title">Ops! No Page</h5>
</div>
<div class="modal-body text-left">
  <p><img src="assets/img/logos/logo.png" border="0" /></p>
</div>
{/if}

      {literal}

      <script src="assets/js/jquery.min.js"></script>
      <script src="assets/js/popper.min.js"></script>
      <script src="assets/js/bootstrap.min.js"></script>
      <script src="assets/lib/@fortawesome/all.min.js"></script>
      <script src="assets/lib/stickyfilljs/stickyfill.min.js"></script>
      <script src="assets/lib/sticky-kit/sticky-kit.min.js"></script>
      <script src="assets/lib/is_js/is.min.js"></script>
      <script src="assets/lib/lodash/lodash.min.js"></script>
      <script src="assets/lib/perfect-scrollbar/perfect-scrollbar.js"></script>
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700%7cPoppins:100,200,300,400,500,600,700,800,900&amp;display=swap" rel="stylesheet">
      <script src="assets/lib/prismjs/prism.js"></script>
      <script src="assets/lib/datatables/js/jquery.dataTables.min.js"></script>
      <script src="assets/lib/datatables-bs4/dataTables.bootstrap4.min.js"></script>
      <script src="assets/lib/datatables.net-responsive/dataTables.responsive.js"></script>
      <script src="assets/lib/datatables.net-responsive-bs4/responsive.bootstrap4.js"></script>  
      <script src="assets/lib/flatpickr/flatpickr.min.js"></script>
      <script src="assets/lib/dropzone/dropzone.min.js"></script>
      <script src="assets/lib/tinymce/tinymce.min.js"></script>
      <script src="assets/js/theme.js"></script>

      <script>
      function hapusfile(iddata, keydata)
        {
          $("#alert_modal").modal('toggle');
          let aa = 1;
          $("#click_yes").click(function()
          {
            if(aa == 1) {

              $.get('{/literal}{$admin_url}mypage/deletefile?id={$Detail.id}&file={literal}' + iddata + '&key=' + keydata, function(data, status){
  
                var obj = jQuery.parseJSON(data);
                if (obj.status=='success')
                {
                  $('#report_all').html(obj.message);
                  $("#alert_modal").modal('hide');
                  editdata('{/literal}{$Detail.id}{literal}');
              } else {
                  $('#report_all').html(obj.message);
              }
              });
              aa++;
            }
            //alert('delete this id: '+iddata);
          });
        }
      function hapuslink(iddata)
        {
          $("#alert_modal").modal('toggle');
          let angka = 1;
          $("#click_yes").click(function()
          {
            if(angka == 1) {
              $.post('{/literal}{$admin_url}mypage/deletelink?id={$Detail.id}{literal}' ,{link:iddata}, function(data, status){
  
                var obj = jQuery.parseJSON(data);
                if (obj.status=='success')
                {
                  $('#report_all').html(obj.message);
                  $("#alert_modal").modal('hide');
                  editdata('{/literal}{$Detail.id}{literal}');
              } else {
                  $('#report_all').html(obj.message);
              }
              });
              angka++;
            }
            //alert('delete this id: '+iddata);
          });
        }
        function addform() {
        $(
          '<input type="text" name="linkFile[]" class="form-control mb-3" multiple placeholder="Link File">'
        ).insertAfter("#btn_add_form_link");
      }
        function addsubpage(iddata)
        {
          $('#sub_add').load('{/literal}{$admin_url}mypage/addsub?idpage={literal}'+iddata,function(){
            $('#addsub').modal({show:true});
          });
        }
        
        $(document).ready(function () {
        if (window.File && window.FileReader) {
          $("#file_edit").on("change", function (e) {
            let number = 0;
            if(number == 0) {
 var files = e.target.files,
              filesLength = files.length;
            for (var i = 0; i < filesLength; i++) {
              var fileName = files[i].name;
              $(
                "<li>" +
                  fileName +
                  " <i class='fas fa-times text-danger hapusGambar'></i></li>"
              ).appendTo("#ListEdit");
              $(".hapusGambar").click(function () {
                $(this).parent().remove();
              });
            }
            number++;
            }
            
           
          });
        } else {
          alert("Your browser doesn't support to File API");
        }
      });

        var request;
        $("#add_submit").submit(function(event){
            
            // var noEditor = $("#no_editor").val();
            // if (noEditor=='no')
              tinymce.triggerSave();

            // Prevent default posting of form - put here to work in case of errors
            event.preventDefault();
            // Abort any pending request
            if (request) {
                request.abort();
            }

            var formData = new FormData(this);

            var noPic = $("#no_picture").val();
            if (noPic=='no')
              formData.append('lbPicture', $('#drop_image')[0].dropzone.getAcceptedFiles()[0]); // attach dropzone image element

            // Fire off the request to /form.php
            request = $.ajax({
                url: "{/literal}{$admin_url}mypage/submit{literal}",
                type: "post",
                //data: serializedData,
                data: formData,
                cache: false, 
                contentType: false, 
                processData: false, 
                //data: new FormData($inputs),
                // xhr: function () {
                //       var myXhr = $.ajaxSettings.xhr();
                //       if (myXhr.upload) {
                //         // For handling the progress of the upload
                //         myXhr.upload.addEventListener('progress', function (e) {
                //           if (e.lengthComputable) {
                //             $('progress').attr({
                //               value: e.loaded,
                //               max: e.total,
                //             });
                //           }
                //         }, false);
                //       }
                //       return myXhr;
                //     }
            });

            // Callback handler that will be called on success
            request.done(function (response, textStatus, jqXHR){
                // Log a message to the console
                console.log(response);
                try {
                  var obj = jQuery.parseJSON(response);
                  //alert(response);
                  if (obj.status=='success')
                  {
                    //$('#report_all').html(obj.message);
                    $("#report_modal").html(obj.message);
                    //$('#add_submit input[type="text"]').val('');
                    //$('#add_submit input[type="file"]').val('');
                    //$('#add_submit textarea').val('');
                    editdata(obj.data);
                    datapage();
                    success_notify();
                  }
                  else
                    $('#report').html(obj.message);
                } catch (error) {
                  alert(error)
                }
            });

            // Callback handler that will be called on failure
            request.fail(function (jqXHR, textStatus, errorThrown){
                // Log the error to the console
                console.error(
                    "The following error occurred: "+
                    textStatus, errorThrown
                );
                $('#report').html('Connection Failed');
            });

            // Callback handler that will be called regardless
            // if the request failed or succeeded
            request.always(function () {
                // Reenable the inputs
              // $inputs.prop("disabled", false);
            });

        });

        function deletephoto(iddata)
        {
          $("#alert_modal").modal('toggle');
          $("#click_yes").click(function()
          {
            $.get("{/literal}{$admin_url}mypage/deletephoto{literal}?idpage="+iddata, function(data, status){

              var obj = jQuery.parseJSON(data);
              if (obj.status=='success')
              {
                $('#report_all').html(obj.message);
                $("#alert_modal").modal('hide');
                // editdconata(iddata);
                editdata('{/literal}{$Detail.id}{literal}');
              }
            });
            //alert('delete this id: '+iddata);
          });
        }
        function deletedatatest(iddata)
        {
          $("#alert_modal").modal('toggle');
          $("#click_yes").click(function()
          {
            $.get("{/literal}{$admin_url}mypage/deletedata{literal}?idpage="+iddata, function(data, status){

              var obj = jQuery.parseJSON(data);
              if (obj.status=='success')
              {
                $('#report_all').html(obj.message);
                $("#alert_modal").modal('hide');
                editdata(iddata);
              }
            });
            //alert('delete this id: '+iddata);
          });
        }

        $('#add').on('hidden.bs.modal', function () {
            $('#report').html('');
        });

        tinymce.init({
    selector: 'textarea.tinymce', 
    plugins: 'link image code', 
    menubar: false, 
    branding: false, 
    toolbar: 'formatselect | bold italic link | alignleft aligncenter alignright alignjustify | bullist numlist | image | undo redo', 
    statusbar: false, 
    relative_urls: true, 
    remove_script_host: true, 
    convert_urls: true, 
    document_base_url: '{/literal}{$base_url}{literal}', 
    
    urlconverter_callback: function(url, node, on_save, name) {
        if (url.startsWith('{/literal}{$base_url}{literal}')) {
            url = url.replace('{/literal}{$base_url}{literal}', '../');
        }
        return url;
    }
});
        function datamodule()
        {
          $('#table_modul').DataTable({
            'processing':true,
            'serverSide':true,
            'scrollX': true,
            'serverMethod':'post',
            'searchDelay':'350',
            'responsive':false,
            'lengthChange':true,
            'autoWidth': true,
            'sWrapper':'falcon-data-table-wrapper',

            'ajax':{
              'url':'{/literal}{$admin_url}mypage/showmodule?idpage={$Detail.id}{literal}'
            },
            'columns':[
              {data:'vName'},
              {data:'vData'},
              {data:'vPicture'},
              {data:'navButton'},
            ],
            // 'dom':'Bfrtip',
            // 'buttons':[
            //   'copy','csv','excel','pdf','print'
            // ],	
            'language':
              {'emptyTable': 'Belum ada data'},
            'destroy':true,
          });
          
        }

        var request;
        $("#module_submit").submit(function(event){

          // Prevent default posting of form - put here to work in case of errors
          event.preventDefault();
          // Abort any pending request
          if (request) {
              request.abort();
          }

          var formData = new FormData(this);

          // Fire off the request to /form.php
          request = $.ajax({
              url: "{/literal}{$admin_url}mypage/submitmodule{literal}",
              type: "post",
              //data: serializedData,
              data: formData,
              cache: false, 
              contentType: false, 
              processData: false, 
              //data: new FormData($inputs),
              // xhr: function () {
              //       var myXhr = $.ajaxSettings.xhr();
              //       if (myXhr.upload) {
              //         // For handling the progress of the upload
              //         myXhr.upload.addEventListener('progress', function (e) {
              //           if (e.lengthComputable) {
              //             $('progress').attr({
              //               value: e.loaded,
              //               max: e.total,
              //             });
              //           }
              //         }, false);
              //       }
              //       return myXhr;
              //     }
          });

          // Callback handler that will be called on success
          request.done(function (response, textStatus, jqXHR){
              // Log a message to the console
              console.log(response);
              var obj = jQuery.parseJSON(response);
              //alert(response);
              if (obj.status=='success')
              {
                //$('#report_all').html(obj.message);
                $("#report_module").html(obj.message);
                $('#module_submit input[type="text"]').val('');
                $('#module_submit input[type="file"]').val('');
                $('#module_submit textarea').val('');
                $('#module_add').modal('hide');
                datamodule();
              }
              else
                $('#report_module').html(obj.message);
          });

          // Callback handler that will be called on failure
          request.fail(function (jqXHR, textStatus, errorThrown){
              // Log the error to the console
              console.error(
                  "The following error occurred: "+
                  textStatus, errorThrown
              );
              $('#report_module').html('Connection Failed');
          });

          // Callback handler that will be called regardless
          // if the request failed or succeeded
          request.always(function () {
              // Reenable the inputs
            // $inputs.prop("disabled", false);
          });

        });

        function deletemodule(iddata)
        {
          if (confirm('Modul ini akan di hapus ?'))
          {
            $.get("{/literal}{$admin_url}mypage/deletemodule{literal}?id="+iddata, function(data, status){

              var obj = jQuery.parseJSON(data);
              if (obj.status=='success')
              {
                $('#report_module').html(obj.message);
                datamodule();
              }
            });
            //alert('delete this id: '+iddata);
          }
        }

        function deletemodulepic(iddata)
        {
          if (confirm('Gambar modul ini akan di hapus ?'))
          {
            $.get("{/literal}{$admin_url}mypage/deletemodulepic{literal}?idmodule="+iddata, function(data, status){

              var obj = jQuery.parseJSON(data);
              if (obj.status=='success')
              {
                $('#report_module').html(obj.message);
                datamodule();
              }
            });
            //alert('delete this id: '+iddata);
          }
        }

        function editmodule(iddata)
        {
          $.get("{/literal}{$admin_url}mypage/editmodule{literal}?idmodule="+iddata, function(data, status){
            $("#module_editor").html(data);
            $('#module_edit').modal('toggle');
          });		
        }

        function addmodule()
        {
          $('#module_add').modal('toggle');
        }

        $('#module_add').on('hidden.bs.modal', function () {
          datamodule();
        });

        $(document).ready(function(){
          $('#table_modul').DataTable().columns.adjust();
          setTimeout(function () {
            datamodule();
          }, 500);
        });

        function success_notify()
        {
          $("#notify_modal").modal('toggle');
          // $("#notify_yes").click(function()
          // {
          //   window.reload();
          //   //alert('delete this id: '+iddata);
          // });
        }

        $(document).ready(function(){
    // Dapatkan waktu saat ini
    var now = new Date();

    $(".editdatetimepicker").flatpickr({
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        minuteIncrement: 1,
        defaultDate: now // Set waktu awal ke waktu saat ini
    });

    $(".editdatepicker").flatpickr({
        dateFormat: "Y-m-d",
        defaultDate: now // Set tanggal awal ke tanggal saat ini
    });

    $(".selectpicker").select2({
        dropdownParent: $("#add")
    });

    $(".dropzone").dropzone({
        url: 'valid/url',
        maxFiles: '1',
        dictDefaultMessage: 'Upload file gambar anda disini',
        addRemoveLinks: true,
        dictRemoveFile: '<span class="badge badge-danger"><i class="fas fa-trash-alt"></i></span>',
        acceptedFiles: 'image/*',
    });
      });
      </script>
      {/literal}

    </body>
    </html>